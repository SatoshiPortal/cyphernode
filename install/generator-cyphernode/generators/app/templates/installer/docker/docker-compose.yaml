version: "3"

services:
  proxy:
    # Bitcoin Mini Proxy
    environment:
      - "TRACING=1"
      - "WATCHER_BTC_NODE_RPC_URL=<%= (bitcoin_mode === 'internal')?'bitcoin':bitcoin_node_ip %>:<%= (net === 'mainnet')?'8332':'18332' %>/wallet/watching01.dat"
      - "WATCHER_BTC_NODE_RPC_USER=<%= bitcoin_rpcuser %>:<%= bitcoin_rpcpassword %>"
      - "WATCHER_BTC_NODE_RPC_CFG=/tmp/watcher_btcnode_curlcfg.properties"
      - "SPENDER_BTC_NODE_RPC_URL=<%= (bitcoin_mode === 'internal')?'bitcoin':bitcoin_node_ip %>:<%= (net === 'mainnet')?'8332':'18332' %>/wallet/spending01.dat"
      - "SPENDER_BTC_NODE_RPC_USER=<%= bitcoin_rpcuser %>:<%= bitcoin_rpcpassword %>"
      - "SPENDER_BTC_NODE_RPC_CFG=/tmp/sender_btcnode_curlcfg.properties"
      - "PROXY_LISTENING_PORT=8888"
      - "DB_PATH=/app/db"
      - "DB_FILE=/app/db/proxydb"
      - "PYCOIN_CONTAINER=pycoin:7777"
      - "OTS_CONTAINER=otsclient:6666"
      - "DERIVATION_PUB32=<%= xpub %>"
      - "DERIVATION_PATH=<%= derivation_path %>"
      - "WATCHER_BTC_NODE_PRUNED=<%= bitcoin_prune?'true':'false' %>"
    image: cyphernode/proxy
    command: "$USER /app/startproxy.sh"
<% if ( devmode ) { %>
    ports:
      - "8888:8888"
<% } %>
    volumes:
      - "<%= proxy_datapath %>:/app/db"
      - "<%= lightning_datapath %>:/app/.lightning"
#    deploy:
#      placement:
#        constraints: [node.hostname==dev]
    networks:
      - cyphernodenet
    restart: always
  proxycron:
    environment:
      - "PROXY_URL=proxy:8888/executecallbacks"
    image: cyphernode/proxycron
#    deploy:
#      placement:
#        constraints: [node.hostname==dev]
    networks:
      - cyphernodenet
    restart: always
  pycoin:
    # Pycoin
    image: cyphernode/pycoin
    environment:
      - "TRACING=1"
      - "PYCOIN_LISTENING_PORT=7777"
<% if ( devmode ) { %>
    ports:
      - "7777:7777"
<% } %>
#    deploy:
#      placement:
#        constraints: [node.hostname==dev]
    networks:
      - cyphernodenet
    restart: always
<% if ( features.indexOf('lightning') !== -1 && lightning_implementation === 'c-lightning' ) { %>
  lightning:
    image: cyphernode/clightning
    ports:
      - "9735:9735"
    volumes:
      - "<%= lightning_datapath%>:/lnuser/.lightning"
#    deploy:
#      placement:
#        constraints: [node.hostname==dev]
    networks:
      - cyphernodenet
    restart: always
<% } %>
<% if( bitcoin_mode === 'internal' ) { %>
  bitcoin:
    image: cyphernode/bitcoin
<% if( bitcoin_expose ) { %>
    ports:
      - "<%= (net === 'mainnet')?'8332:8332':'18332:18332' %>"
<% } %>
    volumes:
      - "<%= bitcoin_datapath%>:/bitcoinuser/.bitcoin"
    networks:
      - cyphernodenet
    restart: always
<% } %>
networks:
  cyphernodenet:
    external: true
